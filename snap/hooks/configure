#!/bin/bash -e

. $SNAP/snap/command-chain/snapcraft-runner

[ ! -e $SNAP_DATA/haproxy.cfg ] && \
cat <<EOF > $SNAP_DATA/haproxy.cfg
defaults
  timeout connect 10s
  timeout client  1m
  timeout server  1m

listen stats
  bind *:8081
  mode http
  stats enable
  stats hide-version
  stats uri /
EOF

mkdir -p $SNAP_DATA/acme/
if [ ! -e $SNAP_DATA/acme/account.key ]; then
  openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:4096 \
    -out $SNAP_DATA/acme/account.key
fi

LETS_ENCRYPT_CERTS="$(snapctl get lets-encrypt-certs)"
LETS_ENCRYPT_TOS="$(snapctl get lets-encrypt-tos)"
LETS_ENCRYPT_CONTACT="$(snapctl get lets-encrypt-contact)"

if [ "x$LETS_ENCRYPT_CONTACT" != "x" ] && [ "x$LETS_ENCRYPT_TOS" == "xaccept" ]; then
  if [ "x$LETS_ENCRYPT_CERTS" != "x" ]; then
    for cert in $LETS_ENCRYPT_CERTS; do
      if [ ! -e $SNAP_DATA/acme/$cert.key ]; then
        openssl genpkey -algorithm RSA -pkeyopt rsa_keygen_bits:2048 \
          -out $SNAP_DATA/acme/$cert.key
      fi

      cat <<EOF > /etc/haproxy/config.lua
config = {
    registration = {
        -- You can read TOS here: https://letsencrypt.org/repository/
        termsOfServiceAgreed = true,
        contact = {"mailto:${LETS_ENCRYPT_CONTACT}"}
    },

    -- ACME certificate authority configuration
    ca = {
        -- HAProxy backend/server which proxies requests to ACME server
        proxy_uri = "http://127.0.0.1:9012",
        -- ACME server URI (also returned by ACME directory listings)
        -- Use this server name in HAProxy config
        uri = "https://acme-v02.api.letsencrypt.org",
    }
}
EOF
    done
  fi
fi

# Reload haproxy service, fall back to a restart.
if [ -e /etc/haproxy/haproxy.pid ]; then
  $SNAP/bin/reload || snapctl restart passprox
else
  snapctl restart passprox
fi
